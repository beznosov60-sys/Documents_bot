# Документы-бот

Телеграм-бот на базе [Aiogram 3](https://docs.aiogram.dev/) для подготовки договоров об оказании юридических услуг. Бот принимает паспортные данные клиента, рассчитывает график платежей и формирует комплект документов в форматах DOCX и PDF.

## Используемые библиотеки

Для работы проекта необходим Python 3.11+ и зависимости из `requirements.txt`:

- `aiogram` — обработка Telegram API и построение конечного автомата состояний.
- `jinja2` — генерация текстовых шаблонов для вводной части договора.
- `python-docx` — создание и форматирование DOCX-файлов договора.
- `reportlab` — построение PDF-версии договора и таблиц платежей.
- `num2words` — преобразование сумм в пропись на русском языке.
- `Babel` — локализованный формат дат.
- `python-dateutil` — разбор пользовательских дат и расчёт отложенных платежей.
- `aiofiles` — асинхронная работа с файлами (используется библиотеками Aiogram при загрузке файлов).
- `easyocr` — распознавание текста с фотографий паспорта.
- `python-dotenv` — загрузка токена бота из файла `.env`.

Установите зависимости одной командой:

```bash
pip install -r requirements.txt
```

## Подготовка окружения

1. **Создайте виртуальное окружение** (рекомендуется):
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```
2. **Установите зависимости**: `pip install -r requirements.txt`.
3. **Получите токен бота** у [@BotFather](https://t.me/BotFather) и сохраните его в файле `.env` или в переменной окружения.
   ```env
   TOKEN_BOT="<ваш_токен>"
   ```
   Также поддерживается переменная `BOT_TOKEN`.
4. **Создайте структуру данных** (будет создана автоматически при первом запуске):
   - `data/counter.json` — счётчик договоров.
   - `data/registry.json` — журнал выданных договоров.
   - `data/passports/` — сохранённые изображения паспортов.
   - `contracts/` — итоговые документы, сгруппированные по клиентам.

## Запуск

```bash
export BOT_TOKEN="<ваш_токен>"  # или заполните файл .env переменной TOKEN_BOT
python -m bot.main
```

После запуска бот начнёт polling и будет обрабатывать входящие сообщения.

## Работа с ботом

- При старте бот просит отправить фотографию паспорта или использовать команду `/manual` для ручного ввода данных.
- Бот распознаёт паспортные данные по фотографии и предлагает их подтвердить. При необходимости можно переключиться на ручной ввод.
- Текстовый ввод должен содержать строки формата `Поле: значение` (ФИО, серия, номер, кем выдан, дата выдачи).
- Далее бот последовательно запрашивает сумму договора и дату первого платежа. Дата распознаётся в формате `ДД.ММ.ГГГГ`.
- После подтверждения бот генерирует договор, сохраняет его в `contracts/` и отправляет пользователю DOCX и PDF.
- Команда `/get_contract` возвращает последний сформированный для пользователя договор.

## Настройка и доработка

- Логи хранятся в стандартном выводе; при необходимости настройте `logging.basicConfig` в `bot/main.py`.
- Тексты разделов договора и структура PDF определены в `bot/utils/documents.py` и могут быть изменены под ваши требования.
- Алгоритм расчёта графика платежей находится в `bot/utils/schedule.py` и задаёт суммы первых трёх месяцев.
- Формат хранения договоров и журналов описан в `bot/utils/registry.py`; при переносе на постоянное хранилище адаптируйте эти функции.

## Полезные команды для разработки

```bash
# Проверить стиль (пример):
ruff check

# Перезапускать бота при изменениях (требуется пакет watchfiles):
watchfiles --filter python 'python -m bot.main'
```

> ⚠️ Для корректной работы распознавания потребуется установить зависимости из `requirements.txt` (включая `easyocr`).
